<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/movie-details-controller.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/movie-details-controller.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { render, Positioning } from "./../utils/index";
import MovieDetails from "../components/movie-details";
import MovieInfo from "../components/movie-info";
import MovieStatusPanel from "../components/movie-status-panel";
import MovieRatingPanel from "../components/movie-rating-panel";
import CommentsListController from "./comments-list-controller";

/**
 * @module
 * @class
 * @name MovieController
 * @classdesc контроллер для работы с popup c подробной информацией о фильме: отрисовка, изменение и обновление данных.
 * @param {String} containerId – id родительского контенйера для рендеринга.
 * @param {Object} movie – объект фильма.
 * @param {Func} onDataChange – обработчик, который вызывается при изменении данных в списке по фильму.
 */
export default class MovieDetailsController {
  constructor(container, onDataChange) {
    this._container = container;
    this._movie = null;
    this._onDataChange = onDataChange;
    this._comments = [];
    this._onDataChangeSubscriptions = [];

    this.hide = this.hide.bind(this);
    this._onEscapeKeyDown = this._onEscapeKeyDown.bind(this);
    this._onCommentInputFocus = this._onCommentInputFocus.bind(this);
    this._onCommentInputBlur = this._onCommentInputBlur.bind(this);
  }

  /**
   * @method
   * @memberof MovieDetailsController
   * @public
   */
  init() {
    this._movieDetails = new MovieDetails(this._movie);
    this._movieInfo = new MovieInfo(this._movie);
    this._movieStatusPanel = new MovieStatusPanel(this._movie);
    this._movieRatingPanel = new MovieRatingPanel(this._movie);
    this._commentsListController = new CommentsListController(
      this._movieDetails.getElement(),
      this._movie,
      this._onDataChange,
      this._onCommentInputFocus,
      this._onCommentInputBlur
    );
    this._commentsListController.init();
    this._onDataChangeSubscriptions.push(
      this._commentsListController._updateCommentsList.bind(
        this._commentsListController
      )
    );
  }

  /**
   * отрисовывает в DOM popup с информацией о фильме
   * @method
   * @memberof MovieDetailsController
   * @public
   * @param {Object} movie - объект фильма
   */
  show(movie) {
    if (this._movieDetails) {
      this.hide();
    }
    this._movie = movie;
    this.init();
    this._renderMoviedDtails();
    this._addEventListeners();
  }

  /**
   * удаляет из DOM popup, если узел существует
   * @method
   * @memberof MovieDetailsController
   * @public
   */
  hide() {
    if (document.body.contains(this._movieDetails.getElement())) {
      this._movieDetails.removeElement();
    }
    this._onDataChangeSubscriptions = [];
    this._movieDetails
      .getElement()
      .querySelector(`.film-details__close-btn`)
      .removeEventListener(`click`, this._hide, false);
    document.removeEventListener(`keydown`, this._onEscapeKeyDown);
  }

  /**
   * отрисовывает содержимое popup
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _renderMoviedDtails() {
    render(
      document.getElementById(`main`),
      this._movieDetails.getElement(),
      Positioning.BEFOREEND
    );

    [this._movieInfo, this._movieStatusPanel, this._movieRatingPanel].forEach(
      component => {
        render(
          this._movieDetails
            .getElement()
            .querySelector(`.form-details__top-container`),
          component.getElement(),
          Positioning.BEFOREEND
        );
      }
    );
  }

  /**
   * обрабатывает изменение данных фильма: рейтинг и категории (watchlist, watched, favorite)
   * @method
   * @memberof MovieDetailsController
   * @private
   * @return {Promise}
   */
  _changeData() {
    const form = this._movieDetails
      .getElement()
      .querySelector(`.film-details__inner`);
    const formData = new FormData(form);

    const entry = {
      isInWatchList: Boolean(formData.get(`watchlist`)),
      isWatched: Boolean(formData.get(`watched`)),
      isFavorite: Boolean(formData.get(`favorite`)),
      personalRate: parseInt(formData.get(`score`), 10) || 0
    };

    return this._onDataChange({ ...this._movie, ...entry });
  }

  /**
   * устанавливает обработчики событий: закрытие popup, сменить категорию, сбросить/поставить рейтинг.
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _addEventListeners() {
    this._movieDetails
      .getElement()
      .querySelector(`.film-details__close-btn`)
      .addEventListener(`click`, this.hide, false);

    this._movieStatusPanel.getElement().addEventListener(`change`, e => {
      if (e.target.tagName !== `INPUT`) {
        return;
      }
      if (e.target.name === `watched`) {
        this._changePersonalRating();
      } else {
        this._changeData();
      }
    });

    this._movieRatingPanel
      .getElement()
      .querySelector(`.film-details__user-rating-score`)
      .addEventListener(`click`, e => {
        if (e.target.tagName !== `INPUT`) {
          return;
        }
        this._changeData();
      });

    this._movieRatingPanel
      .getElement()
      .querySelector(`.film-details__watched-reset`)
      .addEventListener(`click`, () => {
        this._changePersonalRating();
      });

    document.addEventListener(`keydown`, this._onEscapeKeyDown);
  }

  /**
   * обновить данные фильмы и отображение в DOM
   * @method
   * @memberof MovieDetailsController
   * @private
   * @param {Array} movies – актуальный список фильмов
   */
  _updateMovieData(movies) {
    if (!this._movie) {
      return;
    }
    this._movie = movies.find(({ id }) => id === this._movie.id);
    this._updateRatingPanel();
    this._onDataChangeSubscriptions.forEach(subscription => {
      if (!(subscription instanceof Function)) {
        return;
      }
      subscription(this._movie);
    });
  }

  /**
   * установить доступность формы рйтинга - disabled/enabled
   * @method
   * @memberof MovieDetailsController
   * @private
   * @param {Boolean} status - true -> disabled, false -> enabled
   */
  _setRatingPanelDisableStatus(status) {
    this._movieRatingPanel
      .getElement()
      .querySelector(`.film-details__user-rating-score`)
      .querySelectorAll(`input`)
      .forEach(input => (input.disabled = status));
    this._movieRatingPanel
      .getElement()
      .querySelector(`.film-details__watched-reset`).disabled = status;
  }

  /**
   * изменить/установить оценку (рейтинг) фильма
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _changePersonalRating() {
    this._setRatingPanelDisableStatus(true);
    this._changeData()
      .then(() => {
        this._resetPersonalRateForm();
      })
      .finally(() => {
        this._setRatingPanelDisableStatus(false);
      });
  }

  /**
   * сбросить(отменить) рейтинг фильма
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _resetPersonalRateForm() {
    this._movieRatingPanel
      .getElement()
      .querySelector(`.film-details__user-rating-score`)
      .querySelectorAll(`input`)
      .forEach(input => (input.checked = false));
  }

  /**
   * показать/скрыть панель рейтинга в DOM
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _updateRatingPanel() {
    const panelNode = this._movieRatingPanel.getElement();
    if (
      this._movie.isWatched &amp;&amp;
      panelNode.classList.contains(`visually-hidden`)
    ) {
      panelNode.classList.remove(`visually-hidden`);
    }
    if (
      !this._movie.isWatched &amp;&amp;
      !panelNode.classList.contains(`visually-hidden`)
    ) {
      panelNode.classList.add(`visually-hidden`);
    }
    if (!this._movie.isWatched) {
      this._resetPersonalRateForm();
    }
  }

  /**
   * удаляет обработчик собылия `Закрыть popup по Esc`, если после ввода комментария получило фокус.
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _onCommentInputFocus() {
    document.removeEventListener(`keydown`, this._onEscapeKeyDown);
  }

  /**
   * устанавливает обработчик собылия `Закрыть popup по Esc`, если после ввода комментария не в фокусе.
   * @method
   * @memberof MovieDetailsController
   * @private
   */
  _onCommentInputBlur() {
    document.addEventListener(`keydown`, this._onEscapeKeyDown);
  }

  /**
   * закрыть popup по нажатию Esc
   * @method
   * @memberof MovieDetailsController
   * @private
   * @param {Event} e
   */
  _onEscapeKeyDown(e) {
    // не выполняем код повторно, если событие уже запущено
    if (e.defaultPrevented) {
      document.removeEventListener(`keydown`, this._onEscapeKeyDown);
      return;
    }
    e.preventDefault();

    if (e.key === `esc` || e.key === `Escape`) {
      this.hide();
    }
    document.removeEventListener(`keydown`, this._onEscapeKeyDown);
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CommentController.html">CommentController</a></li><li><a href="CommentsListController.html">CommentsListController</a></li><li><a href="MovieController.html">MovieController</a></li><li><a href="MoviesBoardController.html">MoviesBoardController</a></li><li><a href="MoviesListController.html">MoviesListController</a></li><li><a href="NavigationController.html">NavigationController</a></li><li><a href="PageController.html">PageController</a></li><li><a href="SearchController.html">SearchController</a></li><li><a href="StatisticsController.html">StatisticsController</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#Filters">Filters</a></li><li><a href="global.html#formatDurationFromMinutes">formatDurationFromMinutes</a></li><li><a href="global.html#getMoviesDataByFilters">getMoviesDataByFilters</a></li><li><a href="global.html#getUniqueID">getUniqueID</a></li><li><a href="global.html#Positioning">Positioning</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#Screens">Screens</a></li><li><a href="global.html#unrender">unrender</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Feb 15 2020 23:49:05 GMT+0300 (Moscow Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
